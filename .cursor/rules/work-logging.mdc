---
description: Agent作業ログの記録ルール
globs: ["**/*"]
alwaysApply: true
---

# Agent作業ログルール

Cursor Agentが作業を完了した際は、必ず作業ログを記録してください。

## 作業ログファイル

- **ファイルパス**: `docs/AGENT_WORK_LOG.md`
- **形式**: Markdown形式
- **文字エンコーディング**: UTF-8

## 必須ルール

### ⚠️ 重要: 既存の作業ログは上書き禁止

**既存の作業ログは絶対に上書きしてはいけません。必ず文末に追記してください。**

### 作業ログの記録タイミング

以下の作業を完了した際は、必ず作業ログを記録してください：

- 新しいファイルの作成
- 既存ファイルの編集・修正
- 機能の追加・変更
- バグ修正
- リファクタリング
- テストの追加・修正
- ドキュメントの更新
- 設定ファイルの変更

### 作業ログの形式

作業ログは以下の形式で記録してください：

```markdown
---

[YYYY-MM-DD HH:MM:SS]

## 作業内容

作業の概要を簡潔に記述してください。

### 実施した作業

- 作業項目1
- 作業項目2
- 作業項目3

### 変更したファイル

- `path/to/file1.py` - 変更内容の説明
- `path/to/file2.md` - 変更内容の説明

### 備考

追加の情報や注意事項があれば記述してください。

---
```

### 現在時刻の取得

現在時刻は以下のいずれかの方法で取得してください：

#### 方法1: Pythonスクリプトを使用（推奨）

```python
from datetime import datetime

timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
```

または、`tools/get_timestamp.py`スクリプトを使用：

```bash
uv run tools/get_timestamp.py --log
```

#### 方法2: 直接記述

```markdown
[2025-11-17 18:30:45]
```

### 作業ログの追記方法

作業ログファイルを編集する際は、**必ずファイルの末尾に追記**してください。

#### ⭐ 方法1: Cursorのファイル追記機能を使用（最推奨・文字化け回避）

**Cursor Agentが作業ログを追記する際は、必ずCursorのファイル追記機能（`search_replace`ツール）を使用してください。**

PowerShellやPythonスクリプトなどの外部ツールは使用せず、Cursorの標準機能を使用することで、文字化けを確実に回避できます。

**手順:**

1. ファイルの末尾部分を `read_file` で読み込む
2. ファイルの末尾の区切り線（`---`）を `old_string` として指定
3. その区切り線の後に新しいログエントリを追加した内容を `new_string` として指定
4. `search_replace` ツールを使用して追記

**例:**

```typescript
// 1. ファイルの末尾を確認
read_file("docs/AGENT_WORK_LOG.md", offset: 2400)

// 2. search_replaceで追記
search_replace(
  file_path: "docs/AGENT_WORK_LOG.md",
  old_string: "---\n",
  new_string: `---

[2025-11-24 02:58:06]

## 作業内容

作業の概要を記述

### 実施した作業

- 作業項目1
- 作業項目2

### 変更したファイル

- \`path/to/file.py\` - 変更内容

### 備考

追加の情報があれば記述

---
`
)
```

**重要な注意事項:**

- **PowerShellやPythonスクリプトなどの外部ツールは使用しない**
- **必ずCursorの `search_replace` ツールを使用する**
- ファイルの末尾の `---` を `old_string` として指定し、その後に新しいエントリを追加
- 既存の内容は絶対に削除・上書きしない

#### 方法2: Pythonスクリプトを使用（非推奨・文字化けのリスクあり）

```python
from pathlib import Path

log_file = Path("docs/AGENT_WORK_LOG.md")

# 既存の内容を読み込む
existing_content = log_file.read_text(encoding="utf-8") if log_file.exists() else ""

# 新しいログエントリを準備
from datetime import datetime
timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

new_entry = f"""

---

[{timestamp}]

## 作業内容

作業の概要を記述

### 実施した作業

- 作業項目1
- 作業項目2

### 変更したファイル

- `path/to/file.py` - 変更内容

---
"""

# 既存の内容に追記（上書きしない）
updated_content = existing_content + new_entry

# ファイルに書き込む
log_file.write_text(updated_content, encoding="utf-8")
```

#### 方法3: PowerShellで一時ファイルを使用（非推奨・文字化けのリスクあり）

PowerShellで文字化けを防ぐため、既存ファイルを読み込んで結合する方法を使用してください。

```powershell
# 既存のファイルをUTF-8で読み込む
$logFile = "docs/AGENT_WORK_LOG.md"
$existingContent = if (Test-Path $logFile) {
    [System.IO.File]::ReadAllText($logFile, [System.Text.Encoding]::UTF8)
} else {
    ""
}

# 新しいログエントリを一時ファイルに書き出す
$newEntry = @"

---

[2025-11-24 01:09:41]

## 作業内容

作業の概要を記述

### 実施した作業

- 作業項目1
- 作業項目2

### 変更したファイル

- `path/to/file.py` - 変更内容

---
"@

$tempFile = "temp_log_entry.txt"
$newEntry | Out-File -FilePath $tempFile -Encoding UTF8 -NoNewline

# 一時ファイルから読み込む
$newEntryContent = [System.IO.File]::ReadAllText($tempFile, [System.Text.Encoding]::UTF8)

# 既存の内容に追記（上書きしない）
$updatedContent = $existingContent + $newEntryContent

# UTF-8で書き込む（既存内容を保持）
[System.IO.File]::WriteAllText($logFile, $updatedContent, [System.Text.Encoding]::UTF8)

# 一時ファイルを削除
Remove-Item $tempFile -ErrorAction SilentlyContinue
```

#### 方法4: PowerShellで直接結合（非推奨・文字化けのリスクあり）

```powershell
# 既存のファイルをUTF-8で読み込む
$logFile = "docs/AGENT_WORK_LOG.md"
$existingContent = if (Test-Path $logFile) {
    [System.IO.File]::ReadAllText($logFile, [System.Text.Encoding]::UTF8)
} else {
    ""
}

# 新しいログエントリを準備
$newEntry = @"

---

[2025-11-24 01:09:41]

## 作業内容

作業の概要を記述

### 実施した作業

- 作業項目1
- 作業項目2

### 変更したファイル

- `path/to/file.py` - 変更内容

---
"@

# 既存の内容に追記（上書きしない）
$updatedContent = $existingContent + $newEntry

# UTF-8で書き込む（既存内容を保持）
[System.IO.File]::WriteAllText($logFile, $updatedContent, [System.Text.Encoding]::UTF8)
```

> **⚠️ 重要:** 
> - **Cursor Agentが作業ログを追記する際は、必ずCursorのファイル追記機能（`search_replace`ツール）を使用してください。**
> - PowerShellやPythonスクリプトなどの外部ツールは使用しないでください。
> - 外部ツールを使用すると文字化けが発生する可能性があります。

## 注意事項

- **ナンバリングは不要** - 時刻のみで識別します
- **既存の内容は絶対に削除・上書きしない**
- **必ずファイルの末尾に追記する**
- **作業完了後に必ず記録する**
- **簡潔で明確な記述を心がける**
- **Cursor Agentが作業ログを追記する際は、必ずCursorのファイル追記機能（`search_replace`ツール）を使用すること（PowerShellやPythonスクリプトなどの外部ツールは使用しない）**

## ヘルパースクリプトの例

### PowerShell用の安全な追記スクリプト

以下のスクリプトを `tools/append_work_log.ps1` として保存し、使用できます：

```powershell
param(
    [Parameter(Mandatory=$true)]
    [string]$Content
)

$logFile = "docs/AGENT_WORK_LOG.md"

# 既存のファイルをUTF-8で読み込む（存在しない場合は空文字列）
$existingContent = if (Test-Path $logFile) {
    [System.IO.File]::ReadAllText($logFile, [System.Text.Encoding]::UTF8)
} else {
    ""
}

# 新しいエントリを準備（先頭に改行を追加）
$newEntry = "`n`n$Content`n`n---"

# 既存の内容に追記（上書きしない）
$updatedContent = $existingContent + $newEntry

# UTF-8で書き込む（既存内容を保持）
[System.IO.File]::WriteAllText($logFile, $updatedContent, [System.Text.Encoding]::UTF8)

Write-Host "作業ログを追記しました: $logFile"
```

**使用方法:**

```powershell
# 新しいエントリを一時ファイルに書き出す
$newEntry = @"
[2025-11-24 01:09:41]

## 作業内容

作業の概要を記述

### 実施した作業

- 作業項目1
- 作業項目2

### 変更したファイル

- `path/to/file.py` - 変更内容
"@

# スクリプトを実行
.\tools\append_work_log.ps1 -Content $newEntry
```

## 例: 実際の作業ログエントリ

```markdown
---

[2025-11-17 18:30:45]

## 作業内容

Cursor Rulesの追加と設定

### 実施した作業

- `.cursor/rules/`ディレクトリの作成
- Pythonコーディングスタイルルールの作成
- 画像処理ルールの作成
- エラーハンドリングルールの作成
- パフォーマンス最適化ルールの作成
- テストコードルールの作成
- プロジェクト構造ルールの作成
- Komga統合ルールの作成

### 変更したファイル

- `.cursor/rules/python-coding-style.mdc` - 新規作成
- `.cursor/rules/image-processing.mdc` - 新規作成
- `.cursor/rules/error-handling.mdc` - 新規作成
- `.cursor/rules/performance-optimization.mdc` - 新規作成
- `.cursor/rules/testing.mdc` - 新規作成
- `.cursor/rules/project-structure.mdc` - 新規作成
- `.cursor/rules/komga-integration.mdc` - 新規作成

### 備考

プロジェクトの既存コードとドキュメントを分析して、適切なCursor Rulesを作成しました。

---
```
