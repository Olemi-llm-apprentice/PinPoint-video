# 🎯 PinPoint.video - 技術概要

> **YouTube動画から、必要な情報だけをピンポイントで抽出するAIツール**

---

## 🎯 解決する課題

「20分の動画を見たけど、欲しい情報は40秒だった」

→ **AIが「ここだけ見ればいい」を特定し、タイムスタンプ付きリンクを即座に提供**

---

## 🏗️ システム構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Streamlit (Web UI)                           │
└─────────────────────────────────────────────────────────────────────┘
                                  │
┌─────────────────────────────────────────────────────────────────────┐
│                      メインユースケース                              │
│                  (5つの処理Phaseを順次実行)                          │
└─────────────────────────────────────────────────────────────────────┘
        │              │              │              │              │
        ▼              ▼              ▼              ▼              ▼
┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐
│  Gemini   │  │  YouTube  │  │  yt-dlp   │  │  yt-dlp   │  │  Gemini   │
│  2.5 Flash│  │ Data API  │  │ (字幕)    │  │ + ffmpeg  │  │  2.5 Flash│
│  (LLM)    │  │   v3      │  │           │  │ (動画)    │  │  (VLM)    │
└───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘
```

---

## 📋 処理フロー（5 Phase）

---

### Phase 1: 検索クエリ最適化

| 項目 | 内容 |
|------|------|
| **使用技術** | **Gemini 2.5 Flash** (Google AI) |
| **処理内容** | ユーザーの自然言語を、YouTube検索に最適な形に変換 |
| **処理時間** | 1-2秒 |

#### やっていること

1. ユーザーの入力を **Gemini 2.5 Flash** に渡す
2. 3種類の検索クエリを生成させる：
   - **オリジナル**: 入力そのまま（日本語）
   - **最適化版**: 英語キーワードを追加したバージョン
   - **簡略化版**: 核となるキーワードのみ

#### 例

```
入力: 「Claude Code 2.1.2の主な変更点」

出力:
  - オリジナル: "Claude Code 2.1.2の主な変更点"
  - 最適化版: "Claude Code 2.1.2 new features changelog"
  - 簡略化版: "Claude Code 2.1.2"
```

#### なぜ3種類？

- 日本語クエリだけだと英語動画がヒットしない
- 英語クエリだけだと日本語動画がヒットしない
- 複数のクエリで検索することで、漏れを減らす

---

### Phase 2: YouTube動画検索

| 項目 | 内容 |
|------|------|
| **使用技術** | **YouTube Data API v3** (Google) |
| **処理内容** | 複数クエリ×複数戦略で動画を網羅的に検索 |
| **処理時間** | 2-4秒 |

#### やっていること

1. Phase 1で生成した3種類のクエリそれぞれで検索
2. さらに、各クエリを3種類の戦略で検索：

| 戦略 | 説明 |
|------|------|
| **関連性順** | YouTubeのデフォルト（関連性が高い順） |
| **日付順** | 新しい動画優先 |
| **最近1ヶ月+関連性順** | 直近1ヶ月の動画のみ、関連性順 |

3. **3クエリ × 3戦略 = 最大9回検索** を実行
4. 結果を統合し、重複を排除

#### なぜマルチ戦略？

- 「関連性順」だけだと古い人気動画ばかり出てくる
- 「日付順」だけだと関連性の低い動画も出てくる
- 複数戦略を組み合わせることで、新しい＆関連性の高い動画を発見

---

### Phase 2.5: タイトルフィルタリング

| 項目 | 内容 |
|------|------|
| **使用技術** | **Gemini 2.5 Flash** |
| **処理内容** | 動画タイトルを見て、関連性の低い動画を事前に除外 |
| **処理時間** | 1-2秒 |

#### やっていること

1. 検索でヒットした動画のタイトル一覧を **Gemini** に渡す
2. 「ユーザーの質問に関連しそうな動画はどれ？」と聞く
3. 関連性の高そうな動画だけに絞り込む（最大10件）

#### なぜ事前フィルタ？

- 字幕取得には時間がかかる
- 明らかに関係ない動画の字幕を取得するのは無駄
- タイトルで事前にフィルタすることで、処理時間を短縮

---

### Phase 3: 字幕分析

| 項目 | 内容 |
|------|------|
| **使用技術** | **yt-dlp** (字幕取得) + **Gemini 2.5 Flash** (分析) |
| **処理内容** | 字幕テキストから、該当する時間範囲を「粗く」特定 |
| **処理時間** | 4-6秒（並列処理） |

#### やっていること

**Step 1: 字幕取得**
1. **yt-dlp** を使って各動画の字幕をダウンロード
2. 日本語字幕 or 英語字幕を優先
3. 手動字幕がなければ自動生成字幕を使用
4. **5動画を並列処理**で高速化

**Step 2: 範囲特定**
1. 字幕テキスト（時刻付き）を **Gemini 2.5 Flash** に渡す
2. 「ユーザーの質問に関連する部分はどこ？」と聞く
3. 該当する時間範囲（開始秒〜終了秒）と確信度を取得

#### 出力例

```
動画: "Claude Code Tutorial"
  → 120秒〜185秒: ultrathinkモードの有効化手順（確信度 85%）
  → 340秒〜420秒: ultrathinkの実践例（確信度 72%）
```

#### フォールバック機能

字幕取得が失敗した場合（レート制限等）:
- **Gemini 2.5 Flash はYouTube URLを直接理解できる**
- YouTube URLをそのままGeminiに渡して動画を分析

---

### Phase 4: VLM精密分析（部分ダウンロード + 映像AI）

| 項目 | 内容 |
|------|------|
| **使用技術** | **yt-dlp + ffmpeg** (部分DL) + **Gemini 2.5 Flash** (Vision) |
| **処理内容** | 実際に動画をダウンロードし、映像AIで精密な時刻を特定 |
| **処理時間** | 20-40秒（並列処理） |

#### やっていること

**Step 1: 部分ダウンロード** 🎯 **革新ポイント**

1. Phase 3で特定した範囲 + 前後20%のバッファを計算
2. **yt-dlp** でストリーミングURLを取得（ダウンロードしない）
3. **ffmpeg** で**その部分だけ**をダウンロード

```
例: 2時間の動画の 15:00〜19:00 が該当範囲の場合
  → 14:12〜19:48 (前後20%バッファ) の約5分間だけダウンロード
  → 2時間の動画でも、5分のダウンロード時間で済む
```

**Step 2: 映像AI分析**

1. ダウンロードした動画クリップを **Gemini 2.5 Flash (Vision)** にアップロード
2. 「この動画の中で、質問に関連する部分はどこ？」と聞く
3. **映像と音声の両方**を分析して、精密な開始・終了時刻を特定

#### なぜ2段階？

| 段階 | 分析対象 | 精度 | 速度 |
|------|---------|------|------|
| Phase 3 | 字幕テキスト | 粗い | 速い |
| Phase 4 | 実際の映像+音声 | 精密 | 遅い |

- 字幕だけでは見落とす「画面上の説明」も検出可能
- 全動画をVLMで分析すると時間がかかりすぎる
- 字幕で絞り込んでからVLMで精密化、が最適バランス

---

### Phase 5: 結果生成

| 項目 | 内容 |
|------|------|
| **使用技術** | **Gemini 2.5 Flash** (統合サマリー生成) |
| **処理内容** | タイムスタンプ付きリンク生成、結果の統合サマリー作成 |
| **処理時間** | 1-2秒 |

#### 生成するもの

1. **タイムスタンプ付きYouTube埋め込みURL**
   ```
   https://www.youtube.com/embed/abc123?start=900&end=1053
   → 15:00〜17:33 の部分だけ再生される
   ```

2. **各セグメントの要約**
   - 「ultrathinkモードの有効化方法を説明している」
   - 確信度: 92%

3. **統合サマリー**
   - 複数の動画から得られた情報を1つにまとめる
   - 重複を排除して、わかりやすく整理

---

## ⏱️ 処理時間の内訳

| Phase | 処理 | 使用技術 | 時間 |
|-------|------|----------|------|
| 1 | クエリ最適化 | Gemini 2.5 Flash | 1-2秒 |
| 2 | YouTube検索 | YouTube Data API v3 | 2-4秒 |
| 2.5 | タイトルフィルタ | Gemini 2.5 Flash | 1-2秒 |
| 3 | 字幕取得 | yt-dlp | 2-4秒 |
| 3 | 範囲特定 | Gemini 2.5 Flash | 2-3秒 |
| 4 | 部分ダウンロード | yt-dlp + ffmpeg | 15-30秒 |
| 4 | 映像AI分析 | Gemini 2.5 Flash (Vision) | 10-20秒 |
| 5 | 結果生成 | Gemini 2.5 Flash | 1-2秒 |
| **合計** | | | **30秒〜1分** |

> 💡 **ポイント**: 2時間の動画でも処理時間は同じ（部分ダウンロードのおかげ）

---

## 🔧 使用技術まとめ

| 技術 | 提供元 | 用途 |
|------|--------|------|
| **Gemini 2.5 Flash** | Google AI | クエリ最適化、字幕分析、映像分析、サマリー生成 |
| **YouTube Data API v3** | Google | 動画検索、メタデータ取得 |
| **yt-dlp** | OSS | 字幕取得、ストリーミングURL取得 |
| **ffmpeg** | OSS | 動画の部分ダウンロード、クリップ結合 |
| **Streamlit** | Snowflake | Web UI |

---

## 💡 技術的な革新ポイント

### 1. 部分ダウンロード
- 2時間の動画でも、必要な3分だけダウンロード
- HTTP Range Requestを活用した高速シーク
- 処理時間が動画の長さに依存しない

### 2. 2段階AI分析
- **字幕分析（LLM）**: テキストで高速に候補を絞り込み
- **映像分析（VLM）**: 実際の映像で精密に時刻を特定
- 字幕だけでは見落とす「画面上の説明」も検出

### 3. マルチクエリ・マルチ戦略検索
- 3種類のクエリ × 3種類の戦略 = 9回検索
- 重複排除して統合
- 新しい動画も古い動画も漏れなく発見

### 4. フォールバック機能
- 字幕取得失敗時 → YouTube URLを直接Geminiに渡す
- Gemini 2.5はYouTube URLを直接理解できる

---

## 📊 並列処理による高速化

| 処理 | 並列数 | 効果 |
|------|--------|------|
| 字幕取得 | 5並列 | 5動画を同時に処理 |
| VLM分析 | 3並列 | 3動画を同時に分析（レート制限考慮） |

- APIレート制限を考慮した遅延スタート
- エラー時の自動リトライ（最大3回）
- 個別エラーは無視して続行（部分的な結果を返す）

---

*最終更新: 2026-01-10*
